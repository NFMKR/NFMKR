---
title: 基于express的微信小程序开发
date: 2024-10-24 15:13:45
tags:
---
## 目录

### express框架的搭建，环境的配置部署，编写风格的统一

1. express的框架结构搭建
2. 安装部署相关环境 

### 抽卡页api的开发

1. 横幅api
2. 抽卡卡包封面api
3. 抽卡机api
4. 抽卡概率方法

### 图鉴页api的开发

1. 图鉴卡包api
2. 卡牌api

### 用户页面api的开发

1. 登录api
2. 支付api
3. 我的背包api
4. 地址api
5. 用户信息api
6. 发货订单api
7. 抽卡订单api

### 代码与服务器的上传

1. 服务器的使用
2. git和gitlab

## express框架的搭建，环境的配置部署，编写风格的统一

## 抽卡页api的开发

### 刷新实时数据模块中添加缓存功能

1. 实现功能的逻辑
功能：提高概率信息的获取效率，通过缓存机制减少重复的数据库查询。
逻辑流程：
接收请求，提取 Id 值。
检查缓存中是否存在该 Id 的数据且数据有效。
如果有效，直接返回缓存数据；否则进行数据库查询。
从数据库获取相关的卡片机和产品信息，计算合并的概率数据。
将新的概率数据存入缓存并返回。
2. 编写逻辑
初始化一个 cache 对象，用于存储不同 Id 的概率数据和请求时间。
在每次请求时，检查请求的 Id 是否存在于缓存中，且请求时间距离上次请求是否在10秒之内。
如果缓存有效，返回缓存的概率数据。
如果缓存无效，执行后续的数据库查询，获取新的概率数据并合并。
将新的概率数据和当前请求时间存入缓存，以备下次请求使用。
3. 总结知识点和实现原理
缓存机制：通过对象存储请求数据，避免重复的数据库查询，降低响应时间和系统负担。
时间戳管理：使用时间戳来判断缓存的有效性，这是一种常见的缓存策略，能够控制数据的时效性。
异步操作：在 Node.js 中，利用异步操作（如 await）来处理数据库查询，保证代码的非阻塞性。
错误处理：在数据库操作中加入错误处理逻辑，确保系统的稳定性，能够返回适当的错误信息。
实现原理
缓存的实现原理基于“时间窗口”的概念。设定一个有效期（如10秒），在这个时间内，对于相同的请求返回缓存数据，可以显著提高响应速度。通过适当的错误处理和数据验证，确保系统在面对请求时的稳定性与可靠性。
4. 代码实现
```
const cache = {};
if (cache[id] && Date.now() - cache[id].timestamp < 10000) {
  return res.status(200).json({
    code: 200,
    message:"查询缓存",
    data: cache[id].data，
  })；
}
try{
cache[id] = {
  data : nowdata,
  lastfetchTime: currentTime,
};
return res.status(200).json({
  code: 200,
  message:"成功获取目前概率",
  data:nowdate,
});
}catch(error){
  console.error(error);
  res.status(500).json({
    code: 500,
    message: error.message || "服务器错误",
  });
}
```

## 图鉴页api的开发

## 用户页面api的开发

## 刷新实时数据模块中添加缓存功能